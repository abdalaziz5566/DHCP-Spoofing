#!/usr/bin/env python3
import requests
import json
import sys

def register_client(mac_address):
    url = "https://192.168.145.1:8080/api/register"
    
    response = requests.post(url, 
        json={"mac": mac_address},
        verify=False  # For testing only
    )
    
    if response.status_code == 200:
        data = response.json()
        with open(f"cert_{mac_address}.pem", "w") as f:
            f.write(data['certificate'])
        print(f"[+] Certificate saved: cert_{mac_address}.pem")
        return data['certificate']
    else:
        print(f"[-] Registration failed: {response.text}")
        return None

def authenticate_client(mac_address, cert_file):
    with open(cert_file, "r") as f:
        certificate = f.read()
    
    url = "https://192.168.145.1:8080/api/authenticate"
    
    response = requests.post(url,
        json={"mac": mac_address, "certificate": certificate},
        verify=False
    )
    
    if response.status_code == 200:
        print("[+] Authentication successful")
        return True
    else:
        print("[-] Authentication failed")
        return False

if __name__ == "__main__":
    if len(sys.argv) < 2:
        print("Usage: python3 client_auth.py <mac_address>")
        sys.exit(1)
    
    mac = sys.argv[1]
    cert = register_client(mac)
    
    if cert:
        authenticate_client(mac, f"cert_{mac}.pem")